\chapter{基于容器化多终端服务系统架构设计 }\label{chap:service_system}

\section{引言}
% 这一章主要写的就是大背景，边缘设备的空余资源？
% 引言部分要说明目前存着哪些问题
% 需要对空余资源进行管理和利用
% 为何使用去中心化的自组织网络
% 结合微服务特点

本章的内容结构组织如下：第\ref{sec:service_system_related_work}节介绍了一些相关技术的研究工作，包括自治系统的组网技术，微服务架构；第\ref{sec:service_system_design}节介绍了多终端协同服务系统的架构设计，包括引入微服务架构、终端在系统中的身份、系统模块设计等内容；第\ref{sec:service_system_decentralized_network}节提出了多终端协同服务系统的构建方法，包括自治系统的网络选择、自治系统的组网方式、自治系统的管理节点选择等内容；第\ref{sec:service_system_summary}节总结了本章内容。
\section{相关工作}\label{sec:service_system_related_work}
\subsection{自治系统组网技术}



\subsection{微服务架构}


\section{多终端协同服务系统架构设计}\label{sec:service_system_design}
\subsection{终端资源特点}
终端资源拥有如下特点：
\begin{itemize}
    \item 终端资源总体数量庞大
    \item 终端资源单体数量较少
    \item 终端之间异构型强
    \item 终端局部网络通信时延小
\end{itemize}

\subsection{微服务架构}
% 说明微服务架构更适合终端服务系统

微服务架构是一种互联网应用服务的软件架构，主要应用于互联网应用服务的服务端软件开发。微服务架构由面向服务架构SOA发展而来，其核心理论基础来自于康威定律[2]中关于组织结构与其设计的系统结构之间关系的描述，即任何组织设计的系统，其结构都是组织本身沟通结构的复制。

2014年学者Martin Fowler正式提出微服务架构的概念[3]：微服务架构以一套微小的服务的方式来开发和部署一个单独的应用，这些微小的服务根据业务功能来划分，通过自动化部署机制独立部署运行在自己的进程中，微服务之间使用轻量级通信机制来进行通信。一个典型的微服务架构应该包括客户端、微服务网关、服务发现、微服务原子层、数据库、部署平台等模块，根据不同应用类型及服务规模，可以增加负载均衡、权限认证、服务熔断、日志监控等模块，来满足服务的非功能性需求。

虽然Martin Fowler给出了微服务的一种定义，但是他也同时指出，微服务并不局限于该定义。Martin尝试归纳和描述微服务架构风格所具有的共同特点，这些特点并不是所有微服务架构风格都要拥有的,也不是用来定义微服务架构本身的,而是微服务架构风格被希望要拥有的特点。也就是说，微服务架构风格不是微服务化的终点，而是微服务化的方向。下面简单介绍一下文献[3]中总结的几个微服务架构风格的特点。

% \begin{itemize}[leftmargin=12pt]
\begin{itemize}
    \item 服务组件化：微服务中，服务可以被当作进程外组件，独立进行部署，服务之间利用网络服务请求或者远程过程调用来进行通信。一个好的微服务架构的目标是通过服务合同中的解耦服务边界和进化机制来帮助各个微服务独立部署运行。微服务架构的设计者希望对任何一个组件或者服务的改动和升级都只需要重新部署该服务而不需要重新部署整个应用程序，并且在升级过程中尽可能少地改变服务间通信的接口。
    \item 围绕业务功能组织服务：当把一个大的应用拆分成小的部分的时候，通常的方法都是根据技术层面分为UI团队、服务端逻辑团队和数据库团队。但是这种拆分团队的方式会使得即使一个简单的变动都会导致整个团队需要耗费时间和预算来适应和协调。康威在文献[2]中提出了康威定律，其中有一条提到：任何组织设计的系统，其结构都是组织本身沟通结构的复制。根据康威定律的这条描述，微服务架构采用围绕业务功能来拆分应用和组织服务的方法。在微服务架构中，设计组织被分为小的开发团队，与之相对应的是，应用被拆分为小的服务，应用之间的沟通过程就是团队之间的沟通过程。为保证应用之间沟通过程清晰明确，团队之间需要划分清晰的服务边界。这样的划分方法也要求每个小团队本身提供开发过程中所需要的所有技能。
    \item 基础设施自动化：许多开发团队都是使用持续交付和持续集成技术来构建微服务架构的应用和系统的,这使得基础设施自动化技术得到了广泛的应用。而随着容器技术、云计算技术等技术在过去几年的快速发展，基础设施自动化技术取得了长足的进步，这也间接降低了微服务构建、部署、运行的复杂性。

\end{itemize}

根据微服务架构的这些特点，我们可以看出，微服务架构非常适合应用到多终端协同服务系统中。对于终端服务来说，终端拥有海量资源，但这些资源以较为分散的、单体资源较少、终端总数量较多、终端之间异构性强的特点分布在终端上面。将微服务架构引入到多终端协同服务系统中来，可以将终端资源的特点与微服务架构的特点很好地结合起来。

对于单体资源有限的终端来说，庞大而复杂的单体式服务应用会消耗大量终端资源，单个终端难以满足其服务的质量。而海量的空闲终端资源分布较为分散，对于维持和提升单体式服务质量也并没有帮助。将单体式服务改编成组件化的微服务后，每个组件式的微服务都只会消耗较少的终端资源，这样分散的终端资源也能够有效维持和提升微服务的质量，另一方面也是提升了终端资源的利用率。微服务架构围绕业务功能组织服务，拆分后的各个小的应用之间通过轻量级通信机制进行数据通信。而终端之间通常通过局域网交换信息，网络传输速度比较快，节点之间距离近，时延较小，相比传统的终端与云端之间进行远距离通信要更加具有实时性，响应速度更快，终端服务质量也更好。微服务架构使用自动化的基础设施，通常利用容器技术来对服务进行部署和构建，与终端服务系统利用容器技术来管理利用终端资源、形成终端资源池、并以容器的形式对外提供服务的特点非常契合。

\subsection{系统模块设计}
% 整体结构、模块、架构设计图
% 什么时候进行迁移、对终端资源的利用


\subsection{终端在系统中的角色}

基于容器化多终端协同服务系统中的终端有三个身份，每个终端需要完成终端本身为用户提供的工作，即“本地服务”，当终端本身资源不足不能够很好的完成用户请求的任务，则应该通过系统中的调度中心向其他空闲节点请求提供相应资源来进行协同服务，而当终端本身资源有剩余的时候，该终端又可以通过调度中心将本身的资源以容器虚拟化的形式向系统中的其他节点提供出去。

在这个系统中，用户、服务、终端、容器这几个概念之间的关系需要解释一下，如图2所示。用户是整个服务过程的发起者，能够通过自己身边的任何一个设备访问该设备提供的服务，用户对服务的每一次访问都是一次请求任务。服务代表终端能够为用户提供某种服务的能力，是一个比较虚的概念，具体包含两种能力：提供该服务应用的虚拟化容器（或虚拟化镜像）和能够支持该容器快速运行的相应资源。新的服务上线需要向系统注册服务信息，提供服务镜像，上报服务运行所需要的相应资源，并暴露相应服务端口。用户访问服务的过程，实质是用户通过服务对外暴露的端口访问部署在终端上的容器，并由终端向用户提供相应的资源。


\section{多终端协同服务系统的构建方法}\label{sec:service_system_decentralized_network}
\subsection{自治系统的网络选择}
% 这一节主要说明为什么使用去中心化的网络

\subsection{去中心化的自组织网络构建}
% 这一节主要说明如何构建去中心化的自组织网络
自组织网络的应用遍布于军事、数据通信和突发事件处理等领域，其体系结构是指包含协议和拓扑的网络整体设计，拓扑是自组织网络研究中的典型问题。动态条件下建立满足应用的自组织网络是网络体系结构研究的最终目标。自组织网络与现在大部分网络不一样，由于现阶段网络是一种基于客户端－服务器模式下的网络，通过客户端发送请求，利用服务端接收反馈需求，其中各种网络设备在网络中具有特定角色，而自组织网络中的各种设备是对等的。在信息交互时，自组织网络既可以作为客户端，也可做服务端。因为预先建立的基础骨干网设施还不够完善，所以对于终端系统来说，应该使用去中心化的系统架构。

\subsection{自治系统的管理节点选择}
对于整体而言，利用各个节点间的连接情况来构建一个Connectivity-based Decentralized Node Clustering（CDC）。首先选择若干初始种子节点，初始种子节点的选择算法可以进一步进行研究。每个种子向周围的邻居节点发送消息，消息中会携带ID、种子节点ID、权重、TTL、发送节点相关信息等信息，邻居节点在收到消息后会对该消息做一定处理，并加入节点自身相关的信息，再发送到它的邻居节点。节点消息不断传递下去，直到传递到某个已经确定属于其他集群的节点，或者权重信息消耗尽，或者TTL减小到0，则认为消息传递结束，消息传递过程中经过的节点形成一个集群，集群中的节点互相交换相关信息。在集群内部，可以通过考虑上线时间、稳定程度、负载情况、计算能力、邻居数量、网络状态等信息，选择一个超级节点作为集群的任务调度节点。而当有新的节点上线的时候，不需要重新进行集群的划分，而是应该让该节点向周围邻居节点广播消息，根据网络相关程度、上线时间、地理位置、特殊Tag等方法选择周围邻居节点中的一个加入其所在集群。这样就形成了一个整体去中心化、终端节点自治的一个多终端协同服务系统的底层结构，如图1所示是一个简化的模型。

\section{本章小结}\label{sec:service_system_summary}